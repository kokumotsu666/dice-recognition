<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dice Recognition with Local OpenCV.js</title>
    <script src="opencv.js"></script> <!-- ローカルのOpenCV.js -->
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            text-align: center;
        }
        video, canvas {
            max-width: 100%;
            margin: 10px auto;
            display: block;
        }
        #output {
            margin-top: 20px;
        }
        #cameraSelect, #captureButton, #resetButton {
            font-size: 16px;
            padding: 5px 10px;
            margin: 10px 5px;
        }
        #message {
            color: red;
            font-size: 24px;
            font-weight: bold;
            margin-top: 10px;
            height: 40px;
        }
        #loading {
            color: blue;
            font-size: 20px;
            margin-top: 20px;
            display: none;
        }
    </style>
</head>
<body>
    <h1>Dice Recognition with Local OpenCV.js</h1>

    <div id="loading">読み込み中...</div>

    <select id="cameraSelect">
        <option value="environment">背面カメラ</option>
        <option value="user">前面カメラ</option>
    </select>

    <button id="captureButton" disabled>撮影</button>
    <button id="resetButton" disabled>リセット</button>

    <video id="camera" autoplay playsinline></video>
    <canvas id="canvas" style="display:none;"></canvas>

    <div id="output">
        <h2>Results:</h2>
        <p>Dice Values: <span id="dice-values">N/A</span></p>
        <p>Total: <span id="total">N/A</span></p>
        <div id="message"></div>
    </div>

    <script>
        const video = document.getElementById('camera');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const diceValues = document.getElementById('dice-values');
        const total = document.getElementById('total');
        const cameraSelect = document.getElementById('cameraSelect');
        const captureButton = document.getElementById('captureButton');
        const resetButton = document.getElementById('resetButton');
        const message = document.getElementById('message');
        const loading = document.getElementById('loading');

        let currentStream = null;

        async function startCamera(facingMode) {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }
            try {
                const constraints = { video: { facingMode: { exact: facingMode } } };
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = currentStream;
                video.onloadedmetadata = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                };
                resetButton.disabled = true;
                captureButton.disabled = false;
            } catch (err) {
                alert('カメラアクセスエラー: ' + err.message);
                console.error(err);
            }
        }

        cameraSelect.addEventListener('change', () => {
            startCamera(cameraSelect.value);
            diceValues.textContent = 'N/A';
            total.textContent = 'N/A';
            message.textContent = '';
            resetButton.disabled = true;
            captureButton.disabled = false;
        });

        captureButton.addEventListener('click', () => {
            if (!video.videoWidth || !video.videoHeight) {
                alert('カメラ映像の読み込み待ち中です。少し待ってから再度撮影してください。');
                return;
            }
            video.pause();
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            processImage();
            captureButton.disabled = true;
            resetButton.disabled = false;
        });

        resetButton.addEventListener('click', () => {
            diceValues.textContent = 'N/A';
            total.textContent = 'N/A';
            message.textContent = '';
            video.play();
            captureButton.disabled = false;
            resetButton.disabled = true;
        });

        function processImage() {
            try {
                if (!cv || !cv.imread) {
                    throw new Error('OpenCV.jsが完全にロードされていません。ページを再読み込みしてください。');
                }

                let src = cv.imread(canvas);
                let gray = new cv.Mat();
                let blurred = new cv.Mat();
                let binary = new cv.Mat();

                cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
                cv.GaussianBlur(gray, blurred, new cv.Size(5, 5), 0);
                cv.threshold(blurred, binary, 100, 255, cv.THRESH_BINARY_INV);

                let contours = new cv.MatVector();
                let hierarchy = new cv.Mat();
                cv.findContours(binary, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

                let diceResults = [];

                for (let i = 0; i < contours.size(); i++) {
                    let contour = contours.get(i);
                    let rect = cv.boundingRect(contour);
                    let diceROI = binary.roi(rect);

                    let circleCenters = new cv.Mat();
                    cv.HoughCircles(
                        diceROI,
                        circleCenters,
                        cv.HOUGH_GRADIENT,
                        1,
                        diceROI.rows / 8,
                        100,
                        20,
                        5,
                        15
                    );

                    diceResults.push(circleCenters.cols);

                    diceROI.delete();
                    contour.delete();
                    circleCenters.delete();
                }

                if (diceResults.length === 0) {
                    message.textContent = "ダイスがみつかりません";
                    diceValues.textContent = 'N/A';
                    total.textContent = 'N/A';
                } else {
                    message.textContent = '';
                    diceValues.textContent = diceResults.join(', ');
                    total.textContent = diceResults.reduce((sum, num) => sum + num, 0);
                }

                src.delete();
                gray.delete();
                blurred.delete();
                binary.delete();
                contours.delete();
                hierarchy.delete();
            } catch (error) {
                console.error('Processing error:', error);
                alert(`画像処理中にエラーが発生しました: ${error.message}`);
            }
        }

        cv['onRuntimeInitialized'] = () => {
            console.log('OpenCV.jsが初期化されました。');
            loading.style.display = 'none';
            cameraSelect.value = 'environment';
            captureButton.disabled = false;
            startCamera('environment');
        };

        loading.style.display = 'block';
        captureButton.disabled = true;
    </script>
</body>
</html>
