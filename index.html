<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dice Recognition with OpenCV.js</title>
    <script async src="https://docs.opencv.org/4.x/opencv.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            text-align: center;
        }
        video, canvas {
            max-width: 100%;
            margin: 10px auto;
            display: block;
        }
        #output {
            margin-top: 20px;
        }
        #cameraSelect {
            margin-bottom: 10px;
            font-size: 16px;
            padding: 5px;
        }
    </style>
</head>
<body>
    <h1>Dice Recognition with OpenCV.js</h1>

    <!-- iPhone対応：前面／背面カメラ選択 -->
    <select id="cameraSelect">
        <option value="environment">背面カメラ</option>
        <option value="user">前面カメラ</option>
    </select>

    <video id="camera" autoplay playsinline></video>
    <canvas id="canvas"></canvas>

    <div id="output">
        <h2>Results:</h2>
        <p>Dice Values: <span id="dice-values">N/A</span></p>
        <p>Total: <span id="total">N/A</span></p>
    </div>

    <script>
        const video = document.getElementById('camera');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const diceValues = document.getElementById('dice-values');
        const total = document.getElementById('total');
        const cameraSelect = document.getElementById('cameraSelect');

        let currentStream = null;

        async function startCamera(facingMode) {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }
            try {
                const constraints = { video: { facingMode: { exact: facingMode } } };
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = currentStream;
                video.onloadedmetadata = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    processFrame();
                };
            } catch (err) {
                alert('カメラアクセスエラー: ' + err.message);
                console.error(err);
            }
        }

        cameraSelect.addEventListener('change', () => {
            startCamera(cameraSelect.value);
        });

        function processFrame() {
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            try {
                let src = cv.imread(canvas);
                let gray = new cv.Mat();
                let blurred = new cv.Mat();
                let binary = new cv.Mat();

                cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
                cv.GaussianBlur(gray, blurred, new cv.Size(5, 5), 0);
                cv.threshold(blurred, binary, 100, 255, cv.THRESH_BINARY_INV);

                let contours = new cv.MatVector();
                let hierarchy = new cv.Mat();
                cv.findContours(binary, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

                let diceResults = [];

                for (let i = 0; i < contours.size(); i++) {
                    let contour = contours.get(i);
                    let rect = cv.boundingRect(contour);
                    let diceROI = binary.roi(rect);

                    let circleCenters = new cv.Mat();
                    cv.HoughCircles(
                        diceROI,
                        circleCenters,
                        cv.HOUGH_GRADIENT,
                        1,
                        diceROI.rows / 8,
                        100,
                        20,
                        5,
                        15
                    );

                    diceResults.push(circleCenters.cols);

                    diceROI.delete();
                    contour.delete();
                    circleCenters.delete();
                }

                if (diceResults.length === 0) {
                    ctx.font = "48px Arial";
                    ctx.fillStyle = "red";
                    ctx.textAlign = "center";
                    ctx.fillText("ダイスがみつかりません", canvas.width / 2, canvas.height / 2);
                }

                diceValues.textContent = diceResults.join(', ') || 'N/A';
                total.textContent = diceResults.reduce((sum, num) => sum + num, 0) || 'N/A';

                src.delete();
                gray.delete();
                blurred.delete();
                binary.delete();
                contours.delete();
                hierarchy.delete();
            } catch (error) {
                console.error('Processing error:', error);
            }

            requestAnimationFrame(processFrame);
        }

        window.onload = () => {
            cameraSelect.value = 'environment';
            startCamera('environment');
        };
    </script>
</body>
</html>
